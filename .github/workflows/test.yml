name: Python Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "Installing requirements..."
        pip install -r requirements.txt
        echo "Installing package in development mode..."
        pip install -e .
        echo "Installed packages:"
        pip list
        echo "Python path:"
        python -c "import sys; print('\n'.join(sys.path))"
        echo "Checking pandas installation:"
        python -c "import pandas; print(f'pandas version: {pandas.__version__}')"
        
    - name: Set up test files
      run: |
        # Create directories with explicit permissions
        mkdir -p examples inputs outputs
        chmod 777 inputs outputs
        
        # Create example test file
        cat > examples/example_products.csv << EOL
        Product Code,Description,Image1,Image2,Price,Stock
        DEMO001,Example Product 1,https://example.com/img1.jpg,https://example.com/img2.jpg,19.99,100
        DEMO002,Example Product 2,https://example.com/img3.jpg,https://example.com/img4.jpg,29.99,50
        DEMO003,Example Product 3,https://example.com/img5.jpg,https://example.com/img6.jpg,39.99,75
        EOL
        
        # Show workspace contents
        echo "Workspace contents:"
        ls -la
        echo "\nExample contents:"
        ls -la examples/
        
        # Copy example to inputs
        cp examples/example_products.csv inputs/
        echo "\nInputs contents:"
        ls -la inputs/

    - name: Run example split
      run: |
        # Show Python environment info
        echo "Python version:"
        python --version
        echo "\nPython path:"
        python -c "import sys; print('\n'.join(sys.path))"
        
        # Show input file contents
        echo "\nInput file contents:"
        cat inputs/example_products.csv
        
        # Run autosplit with debug output and catch any errors
        python -m autosplit.cli inputs/example_products.csv --key-col "Product Code" --min-images 1 --xlsx || {
          echo "Error running autosplit"
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "\nInputs directory:"
          ls -la inputs/
          echo "\nOutputs directory:"
          ls -la outputs/ || echo "outputs/ not found"
          exit 1
        }
        
        # Show current directory and its contents
        pwd
        echo "\nCurrent directory contents:"
        ls -la
        
        echo "\nOutputs directory contents (if exists):"
        ls -la outputs/ || echo "outputs/ directory not found or empty"
        
    - name: Check outputs
      run: |
        if [ ! -f "outputs/manifest.csv" ]; then
          echo "Error: manifest.csv not found in outputs directory"
          echo "Current directory:"
          pwd
          echo "\nDirectory contents:"
          ls -la
          echo "\nOutputs directory (if exists):"
          ls -la outputs/ || echo "outputs/ directory not found"
          exit 1
        fi
        echo "Test completed successfully - manifest.csv found"