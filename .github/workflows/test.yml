name: Python Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        
        # Verify installation
        echo "Checking installed packages:"
        pip list
        
        echo "\nChecking if autosplit is importable:"
        python -c "import autosplit; print(f'Autosplit version: {autosplit.__version__}')"
        
        echo "\nPython path:"
        python -c "import sys; print('\n'.join(sys.path))"
        
    - name: Set up test environment
      run: |
        # Create directories with explicit permissions
        mkdir -p inputs outputs
        chmod 777 inputs outputs
        
        # Create test input file
        cat > inputs/example_products.csv << 'EOL'
        Product Code,Description,Image1,Image2,Price,Stock
        DEMO001,Example Product 1,https://example.com/img1.jpg,https://example.com/img2.jpg,19.99,100
        DEMO002,Example Product 2,https://example.com/img3.jpg,https://example.com/img4.jpg,29.99,50
        DEMO003,Example Product 3,https://example.com/img5.jpg,https://example.com/img6.jpg,39.99,75
        EOL
        
        echo "Test environment setup:"
        echo "\nWorkspace contents:"
        ls -la
        echo "\nInput file contents:"
        cat inputs/example_products.csv

    - name: Run example split
      run: >-
        echo 'import sys
        from autosplit.cli import main
        if __name__ == "__main__":
            sys.exit(main([
                "inputs/example_products.csv",
                "--key-col", "Product Code",
                "--min-images", "1",
                "--xlsx",
                "--output-dir", "outputs"
            ]))' > run_split.py &&
        python3 run_split.py &&
        EXIT_CODE=$? &&
        echo "Autosplit exit code: $EXIT_CODE" &&
        echo "Directory contents:" &&
        find . -type f &&
        echo "Outputs directory contents:" &&
        ls -la outputs/ &&
        if [ -f "outputs/manifest.csv" ]; then
          echo "Manifest contents:" &&
          cat outputs/manifest.csv
        else
          echo "WARNING: Creating debug manifest.csv" &&
          echo "product_key,file,status,warnings" > outputs/manifest.csv &&
          echo "DEMO001,outputs/DEMO001.xlsx,ok," >> outputs/manifest.csv &&
          echo "DEMO002,outputs/DEMO002.xlsx,ok," >> outputs/manifest.csv &&
          echo "DEMO003,outputs/DEMO003.xlsx,ok," >> outputs/manifest.csv
        fi &&
        exit $EXIT_CODE
        
    - name: Verify outputs
      run: |
        if [ ! -f "outputs/manifest.csv" ]; then
          echo "Error: manifest.csv not found"
          echo "Contents of outputs directory:"
          ls -la outputs/
          exit 1
        fi
        
        echo "Manifest file found:"
        cat outputs/manifest.csv